package main

import (
	"log"
	"net/http"

	"github.com/mark3labs/mcp-go/server"
	"github.com/prometheus/client_golang/prometheus"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
	registry = prometheus.NewRegistry()

	activeConnections = prometheus.NewGauge(prometheus.GaugeOpts{
		Name: "mcp_active_connections",
		Help: "Number of active MCP connections",
	})

	requestsTotal = prometheus.NewCounterVec(prometheus.CounterOpts{
		Name: "mcp_requests_total",
		Help: "Total number of MCP requests",
	}, []string{"endpoint"})
)

func init() {
	registry.MustRegister(activeConnections)
	registry.MustRegister(requestsTotal)
}

func main() {
	s := server.NewMCPServer(
		"Kubernetes MCP Server",
		"0.0.1",
		server.WithToolCapabilities(true),
	)

	// Create SSE server for MCP with options
	sseServer := server.NewSSEServer(s,
		server.WithSSEEndpoint("/sse"),
		server.WithMessageEndpoint("/message"),
	)

	toolGetPodDetails := mcp.NewTool("get_pod_details",
		mcp.WithDescription("Pod detaylarını (spec, status) getirir"),
		mcp.WithString("podName",
			mcp.Description("Pod ismi"),
			mcp.Required(),
		),
		mcp.WithString("namespace",
			mcp.Description("Namespace (varsayılan: default)"),
			mcp.DefaultString("default"),
		),
	)

	s.AddTool(toolGetPodDetails, getPodHandler)

	// Setup HTTP mux
	mux := http.NewServeMux()

	// Add Prometheus metrics endpoint
	mux.Handle("/metrics", promhttp.HandlerFor(registry, promhttp.HandlerOpts{}))

	// Add SSE endpoints for MCP with connection tracking
	mux.Handle("/sse", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		activeConnections.Inc()
		defer activeConnections.Dec()
		requestsTotal.WithLabelValues("sse").Inc()
		sseServer.SSEHandler().ServeHTTP(w, r)
	}))

	mux.Handle("/message", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		requestsTotal.WithLabelValues("message").Inc()
		sseServer.MessageHandler().ServeHTTP(w, r)
	}))

	// Add root endpoint for MCP (LibreChat might try this)
	mux.Handle("/", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		if r.URL.Path == "/" {
			activeConnections.Inc()
			defer activeConnections.Dec()
			requestsTotal.WithLabelValues("root").Inc()
			sseServer.SSEHandler().ServeHTTP(w, r)
		} else {
			http.NotFound(w, r)
		}
	}))

	// Start HTTP server
	addr := ":3334"
	log.Printf("Starting Kubernetes MCP Server on %s...", addr)
	log.Printf("SSE endpoint: :%s/sse", addr)
	log.Printf("Message endpoint: :%s/message", addr)
	log.Printf("Metrics endpoint: :%s/metrics", addr)
	log.Printf("Root endpoint (MCP): :%s/", addr)

	if err := http.ListenAndServe(addr, mux); err != nil {
		log.Fatalf("Server error: %v", err)
	}
}